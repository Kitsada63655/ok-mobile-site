<script>
  let allProducts = [];

  function renderProducts(products) {
    const container = document.getElementById('product-list');
    container.innerHTML = '';
    products.forEach(product => {
      const card = document.createElement('div');
      const outOfStock = product.จำนวนสินค้า == '0';
      card.className = 'relative bg-white rounded-xl shadow-md overflow-hidden p-4 flex flex-col transition transform hover:-translate-y-1 hover:shadow-lg ' + (outOfStock ? 'out-of-stock' : '');

      let priceSection = `<p class="text-blue-600 font-semibold mt-2 text-lg">฿${product.ราคา}</p>`;
      if (product.ราคาปกติ && parseFloat(product.ราคาปกติ) > parseFloat(product.ราคา)) {
        priceSection = `
          <div class="mt-2">
            <span class="text-red-500 font-bold text-lg">฿${product.ราคา}</span>
            <span class="line-through text-gray-400 ml-2 text-sm">฿${product.ราคาปกติ}</span>
          </div>`;
      }

      card.innerHTML = `
        <div class="relative">
          ${product.ราคาปกติ && parseFloat(product.ราคาปกติ) > parseFloat(product.ราคา) ? '<div class="badge-sale">ลดราคา</div>' : ''}
          <img src="${product.รูปภาพ}" alt="${product.ชื่อสินค้า}" class="rounded-md mb-3 h-48 w-full object-cover">
        </div>
        <h3 class="text-lg font-bold text-gray-800">${product.ชื่อสินค้า}</h3>
        <p class="text-sm text-gray-600">${product.รายละเอียด}</p>
        ${priceSection}
        <p class="text-sm text-gray-500 mt-1">จำนวนสินค้า: ${product.จำนวนสินค้า}</p>
        <a href="${product.ลิงก์ไลน์}" target="_blank" class="mt-auto bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg text-center block mt-4">${outOfStock ? 'สินค้าหมด' : 'สั่งซื้อผ่านไลน์'}</a>
      `;

      container.appendChild(card);
    });
  }

  fetch('https://opensheet.elk.sh/1MNmqRmiu4-8s1V9lI8oV1Gn5wb0jYqYs-xhkj-UZ0FM/Sheet1')
    .then(res => res.json())
    .then(data => {
      allProducts = data;
      renderProducts(data);

      const brands = [...new Set(data.map(p => p.แบรนด์))].filter(Boolean);
      const categories = [...new Set(data.map(p => p.หมวดหมู่))].filter(Boolean);

      const brandFilter = document.getElementById('brandFilter');
      brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandFilter.appendChild(option);
      });

      const categoryFilter = document.getElementById('categoryFilter');
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
    });

  document.getElementById('search').addEventListener('input', filterProducts);
  document.getElementById('brandFilter').addEventListener('change', filterProducts);
  document.getElementById('categoryFilter').addEventListener('change', filterProducts);

  function filterProducts() {
    const keyword = document.getElementById('search').value.toLowerCase();
    const brand = document.getElementById('brandFilter').value;
    const category = document.getElementById('categoryFilter').value;

    const filtered = allProducts.filter(p => {
      const matchKeyword = p.ชื่อสินค้า.toLowerCase().includes(keyword);
      const matchBrand = !brand || p.แบรนด์ === brand;
      const matchCategory = !category || p.หมวดหมู่ === category;
      return matchKeyword && matchBrand && matchCategory;
    });

    renderProducts(filtered);
  }
</script>
